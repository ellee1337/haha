-- 🌌 Fly + ESP Script with Ghost UI
-- ✅ Works with Rayfield or GhostPlayer352’s Ghost UI Library

-- 🧩 Load Ghost UI
local Rayfield = loadstring(game:HttpGet('https://raw.githubusercontent.com/GhostPlayer352/UI-Library/refs/heads/main/Ghost%20Gui'))()

----------------------------------------------------------------
-- ⚙️ Services
----------------------------------------------------------------
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

----------------------------------------------------------------
-- ✈️ Fly Script
----------------------------------------------------------------
local torso = nil
local flying = false
local ctrl = {f = 0, b = 0, l = 0, r = 0}
local lastctrl = {f = 0, b = 0, l = 0, r = 0}
local maxspeed = 50
local speed = 0
local bg = nil
local bv = nil

local function Fly()
	if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("Torso") then return end
	torso = LocalPlayer.Character.Torso
	game.StarterGui:SetCore("SendNotification", {Title="Fly Activated"; Text="Ghost UI"; Duration=1;})
	
	bg = Instance.new("BodyGyro", torso)
	bg.P = 9e4
	bg.maxTorque = Vector3.new(9e9, 9e9, 9e9)
	bg.cframe = torso.CFrame
	
	bv = Instance.new("BodyVelocity", torso)
	bv.velocity = Vector3.new(0, 0.1, 0)
	bv.maxForce = Vector3.new(9e9, 9e9, 9e9)

	repeat
		task.wait()
		LocalPlayer.Character.Humanoid.PlatformStand = true
		if ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0 then
			speed = speed + .5 + (speed / maxspeed)
			if speed > maxspeed then speed = maxspeed end
		elseif speed ~= 0 then
			speed = speed - 1
			if speed < 0 then speed = 0 end
		end
		
		if ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0 then
			bv.velocity = ((workspace.CurrentCamera.CFrame.LookVector * (ctrl.f + ctrl.b)) +
				((workspace.CurrentCamera.CFrame * CFrame.new(ctrl.l + ctrl.r, (ctrl.f + ctrl.b) * .2, 0).p) -
				workspace.CurrentCamera.CFrame.p)) * speed
			lastctrl = {f = ctrl.f, b = ctrl.b, l = ctrl.l, r = ctrl.r}
		elseif speed ~= 0 then
			bv.velocity = ((workspace.CurrentCamera.CFrame.LookVector * (lastctrl.f + lastctrl.b)) +
				((workspace.CurrentCamera.CFrame * CFrame.new(lastctrl.l + lastctrl.r, (lastctrl.f + lastctrl.b) * .2, 0).p) -
				workspace.CurrentCamera.CFrame.p)) * speed
		else
			bv.velocity = Vector3.new(0, 0.1, 0)
		end
		bg.CFrame = workspace.CurrentCamera.CFrame * CFrame.Angles(-math.rad((ctrl.f + ctrl.b) * 50 * speed / maxspeed), 0, 0)
	until not flying

	ctrl, lastctrl, speed = {f = 0, b = 0, l = 0, r = 0}, {f = 0, b = 0, l = 0, r = 0}, 0
	bg:Destroy(); bv:Destroy()
	LocalPlayer.Character.Humanoid.PlatformStand = false
	game.StarterGui:SetCore("SendNotification", {Title="Fly Deactivated"; Text="Ghost UI"; Duration=1;})
end

-- Movement Controls
Mouse.KeyDown:Connect(function(key)
	if key:lower() == "w" then ctrl.f = 1
	elseif key:lower() == "s" then ctrl.b = -1
	elseif key:lower() == "a" then ctrl.l = -1
	elseif key:lower() == "d" then ctrl.r = 1 end
end)
Mouse.KeyUp:Connect(function(key)
	if key:lower() == "w" then ctrl.f = 0
	elseif key:lower() == "s" then ctrl.b = 0
	elseif key:lower() == "a" then ctrl.l = 0
	elseif key:lower() == "d" then ctrl.r = 0 end
end)

----------------------------------------------------------------
-- 👁️ ESP System
----------------------------------------------------------------
local ESP = {
    Enabled = false,
    Boxes = true,
    BoxShift = CFrame.new(0, -1.5, 0),
    BoxSize = Vector3.new(4, 6, 0),
    Color = Color3.fromRGB(255, 170, 0),
    FaceCamera = false,
    Names = true,
    Thickness = 2,
    Players = true,
    Objects = setmetatable({}, {__mode = "kv"}),
}

local cam = workspace.CurrentCamera
local function Draw(obj, props)
	local new = Drawing.new(obj)
	for i,v in pairs(props or {}) do new[i] = v end
	return new
end

local boxBase = {}
boxBase.__index = boxBase

function boxBase:Remove()
	ESP.Objects[self.Object] = nil
	for _,v in pairs(self.Components) do v.Visible = false v:Remove() end
end

function boxBase:Update()
	if not self.PrimaryPart or not workspace:IsAncestorOf(self.PrimaryPart) then return self:Remove() end
	local color = self.Color or ESP.Color
	local cf = self.PrimaryPart.CFrame
	local size = self.Size

	local locs = {
		TopLeft = cf * ESP.BoxShift * CFrame.new(size.X/2, size.Y/2, 0),
		TopRight = cf * ESP.BoxShift * CFrame.new(-size.X/2, size.Y/2, 0),
		BottomLeft = cf * ESP.BoxShift * CFrame.new(size.X/2, -size.Y/2, 0),
		BottomRight = cf * ESP.BoxShift * CFrame.new(-size.X/2, -size.Y/2, 0),
		TagPos = cf * ESP.BoxShift * CFrame.new(0, size.Y/2, 0)
	}

	local TL, V1 = cam:WorldToViewportPoint(locs.TopLeft.p)
	local TR, V2 = cam:WorldToViewportPoint(locs.TopRight.p)
	local BL, V3 = cam:WorldToViewportPoint(locs.BottomLeft.p)
	local BR, V4 = cam:WorldToViewportPoint(locs.BottomRight.p)
	local TP, V5 = cam:WorldToViewportPoint(locs.TagPos.p)

	if ESP.Boxes and (V1 or V2 or V3 or V4) then
		self.Components.Quad.Visible = true
		self.Components.Quad.PointA = Vector2.new(TR.X, TR.Y)
		self.Components.Quad.PointB = Vector2.new(TL.X, TL.Y)
		self.Components.Quad.PointC = Vector2.new(BL.X, BL.Y)
		self.Components.Quad.PointD = Vector2.new(BR.X, BR.Y)
		self.Components.Quad.Color = color
	else
		self.Components.Quad.Visible = false
	end

	if ESP.Names and V5 then
		self.Components.Name.Visible = true
		self.Components.Name.Position = Vector2.new(TP.X, TP.Y)
		self.Components.Name.Text = self.Name
		self.Components.Name.Color = color
	else
		self.Components.Name.Visible = false
	end
end

function ESP:Add(obj, options)
	local box = setmetatable({
		Name = options.Name or obj.Name,
		Object = obj,
		PrimaryPart = options.PrimaryPart,
		Color = options.Color or ESP.Color,
		Size = options.Size or ESP.BoxSize,
		Components = {}
	}, boxBase)

	box.Components.Quad = Draw("Quad", {Thickness = ESP.Thickness, Color = box.Color, Visible = ESP.Enabled})
	box.Components.Name = Draw("Text", {Text = box.Name, Color = box.Color, Center = true, Outline = true, Size = 18, Visible = ESP.Names})
	ESP.Objects[obj] = box

	return box
end

local function CharAdded(char)
	local p = Players:GetPlayerFromCharacter(char)
	local root = char:WaitForChild("HumanoidRootPart", 10)
	if root then
		ESP:Add(char, {Name = p.Name, PrimaryPart = root})
	end
end

Players.PlayerAdded:Connect(function(p)
	p.CharacterAdded:Connect(CharAdded)
	if p.Character then CharAdded(p.Character) end
end)

for _,p in pairs(Players:GetPlayers()) do
	if p ~= LocalPlayer then
		if p.Character then CharAdded(p.Character) end
		p.CharacterAdded:Connect(CharAdded)
	end
end

RunService.RenderStepped:Connect(function()
	if ESP.Enabled then
		for _,v in pairs(ESP.Objects) do
			local ok, err = pcall(v.Update, v)
			if not ok then warn(err) end
		end
	else
		for _,v in pairs(ESP.Objects) do
			for _,comp in pairs(v.Components) do comp.Visible = false end
		end
	end
end)

----------------------------------------------------------------
-- 🎛️ Ghost UI Setup
----------------------------------------------------------------
local Window = Rayfield:CreateWindow("⚡ Fly + ESP Control Panel ⚡")

Window:AddContent("Label", "Made by CookieCodes + ChatGPT")

Window:AddContent("Toggle", "Fly Mode (Press E or Toggle)", function(state)
	flying = state
	if state then Fly() end
end)

Window:AddContent("Toggle", "ESP Boxes + Names", function(state)
	ESP.Enabled = state
end)

Window:AddContent("Button", "Notify Info", function()
	game.StarterGui:SetCore("SendNotification", {Title="Ghost UI"; Text="Fly: [E] key • ESP: Toggle Button"; Duration=3;})
end)
